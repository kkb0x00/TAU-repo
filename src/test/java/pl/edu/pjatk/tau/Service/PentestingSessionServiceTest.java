package pl.edu.pjatk.tau.Service;

import org.junit.Assert;
import org.junit.Before;

import pl.edu.pjatk.tau.Domain.IOTimes;
import pl.edu.pjatk.tau.Domain.PentestingSession;
import pl.edu.pjatk.tau.Repository.PentestRepository;

import java.util.ArrayList;
import java.util.List;

import static org.mockito.Mockito.*;

public class PentestingSessionServiceTest {
    private PentestingSessionService sessionService;
    private PentestingSession firstSession = null;
    private PentestingSession secondSession = null;
    private IOTimesService ioTimesService = null;

    @Before
    public void setUp() {
        ioTimesService = mock(IOTimesService.class);
        doNothing().when(ioTimesService).setInsertTime(any(IOTimes.class));
        doNothing().when(ioTimesService).setlastReadTime(any(IOTimes.class));
        doNothing().when(ioTimesService).setlastUpdateTime(any(IOTimes.class));

        List<PentestingSession> sessions = new ArrayList<>();
        firstSession = new PentestingSession("test1");
        firstSession.setId(1);

        secondSession = new PentestingSession("test2");
        secondSession.setId(2);

        sessions.add(firstSession);
        sessions.add(secondSession);

        sessionService = new PentestingSessionService(new PentestRepository(sessions), ioTimesService);
    }

    @org.junit.Test
    public void shouldReturnFirstSessionFromDatabaseTest() {
        PentestingSession element = sessionService.get(1);
        Assert.assertEquals(element, firstSession);
    }

    @org.junit.Test
    public void shouldReturnLastSessionFromDatabaseTest() {
        PentestingSession element = sessionService.get(2);
        Assert.assertEquals(element, secondSession);
    }

    @org.junit.Test
    public void shouldReturnNullSessionTest() {
        Assert.assertNull(sessionService.get(444));
    }

    @org.junit.Test
    public void shouldReturnAllSessionsFromDatabaseTest() {
        List<PentestingSession> sessionsList = new ArrayList<PentestingSession>();
        sessionsList.add(firstSession);
        sessionsList.add(secondSession);

        List<PentestingSession> sessions = sessionService.getAll();
        Assert.assertEquals(sessions, sessionsList);
    }

    @org.junit.Test
    public void shouldAddPentestingSessionTest() {
        String title = "test123";

        PentestingSession newSession = new PentestingSession(title);
        sessionService.add(newSession);

        Assert.assertEquals(sessionService.get(3), newSession);
//        Assert.assertEquals(sessionService.get(3).getTitle(), title);
        Assert.assertEquals(sessionService.getAll().size(), 3);
    }

    @org.junit.Test
    public void shouldUpdatePentestingSessionTest() {
        PentestingSession updatedSession = new PentestingSession("testUpdate");
        updatedSession.setId(1);

        sessionService.update(updatedSession);

        Assert.assertEquals(sessionService.get(1).getTitle(), "testUpdate");
    }

    @org.junit.Test
    public void shouldDeletePentestingSessionTest() {
        sessionService.delete(1);

        Assert.assertEquals(sessionService.getAll().size(), 1);
    }

    @org.junit.Test
    public void shouldCallOnceIOTimesServiceOnGetTest() {
        PentestingSession element = sessionService.get(1);

        verify(ioTimesService, atLeast(1)).setlastReadTime(element);
        verify(ioTimesService, atMost(1)).setlastReadTime(element);
    }

    @org.junit.Test
    public void shouldOnlyCallSetLastReadTimeOnGetTest() {
        PentestingSession session = sessionService.get(1);

        verify(ioTimesService, only()).setlastReadTime(session);
    }

    @org.junit.Test
    public void shouldCallExactTimesIOTimesServiceOnGetAllTest() {
        List<PentestingSession> sessionsList = new ArrayList<PentestingSession>();
        sessionsList.add(firstSession);
        sessionsList.add(secondSession);

        sessionService.getAll();

        verify(ioTimesService, times(sessionsList.size())).setlastReadTime(any(IOTimes.class));
    }

    @org.junit.Test
    public void shouldCallOnceIOTimesServiceOnInsertTest() {
        PentestingSession session = new PentestingSession("test1");
        sessionService.add(session);

        verify(ioTimesService, atLeast(1)).setInsertTime(session);
        verify(ioTimesService, atMost(1)).setInsertTime(session);
    }

    @org.junit.Test
    public void shouldOnlyCallSetLastInsertTimeOnAddTest() {
        PentestingSession session = new PentestingSession("test1");
        sessionService.add(session);

        verify(ioTimesService, only()).setInsertTime(session);
    }

    @org.junit.Test
    public void shouldCallOnceIOTimesServiceOnUpdateTest() {
        PentestingSession session = new PentestingSession("test1");
        session.setId(1);

        sessionService.update(session);

        verify(ioTimesService, atLeast(1)).setlastUpdateTime(session);
        verify(ioTimesService, atMost(1)).setlastUpdateTime(session);
    }

    @org.junit.Test
    public void shouldOnlyCallSetLastUpdateTimeOnAddTest() {
        PentestingSession session = new PentestingSession("test1");
        session.setId(1);

        sessionService.update(session);

        verify(ioTimesService, only()).setlastUpdateTime(session);
    }
}